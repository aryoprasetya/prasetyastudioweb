<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kas SAGARA — Sistem Keuangan</title>
<link rel="icon" href="images/logo.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<style>
:root { --navy:#0b2340; --muted:#64748b; --bg:#f5f7fb; --card:#ffffff; }
[data-theme="dark"]{ --navy:#f5f7fb; --muted:#94a3b8; --bg:#0b2340; --card:#1e293b; }
* { box-sizing: border-box; font-family: 'Manrope', sans-serif; }
body { margin:0; background:var(--bg); color:var(--navy); line-height:1.5; transition:0.3s; }
header { display:flex; align-items:center; justify-content:space-between; padding:20px 24px; background:var(--card); box-shadow:0 4px 20px rgba(0,0,0,0.05); flex-wrap:wrap; gap:10px; }
.brand { display:flex; align-items:center; gap:14px; flex-wrap:wrap; }
.brand img { width:72px; height:72px; object-fit:contain; }
.brand h1 { margin:0; font-size:22px; font-weight:700; }
.brand p { margin:2px 0 0; color:var(--muted); font-size:14px; }
.container { max-width:1200px; margin:30px auto; padding:0 20px; display:grid; grid-template-columns:2fr 1fr; gap:20px; }
.card { background:var(--card); border-radius:14px; padding:22px; box-shadow:0 6px 24px rgba(11,35,64,0.06); transition:0.3s; }
h3 { margin-top:0; font-size:18px; display:flex; align-items:center; gap:6px; }
label { display:block; font-size:13px; color:var(--muted); margin-bottom:4px; margin-top:8px; }
input[type=text], input[type=number], input[type=date], select { width:100%; padding:10px 12px; border:1px solid #e2e8f0; border-radius:8px; font-size:14px; }
button { background:var(--navy); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; transition:all .2s ease; }
button:hover { opacity:.9; }
table { width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; }
th, td { border:1px solid #e2e8f0; padding:8px 6px; text-align:left; }
th { color:var(--muted); font-weight:600; background:#f0f0f0; }
.list-empty { text-align:center; color:var(--muted); padding:12px; }
footer { text-align:center; font-size:13px; color:var(--muted); margin:30px 0; padding:0 10px; }
#qr-reader { width:100%; margin-top:12px; border-radius:12px; overflow:hidden; }
@media(max-width:1024px){ .container { grid-template-columns:1fr; } }
@media(max-width:600px){ header { flex-direction:column; align-items:flex-start; justify-content:flex-start; text-align:left; } .brand img { width:60px; height:60px; } .card { padding:16px; } table { font-size:13px; } button, input { font-size:13px; } h3 { font-size:16px; } }
</style>
</head>
<body data-theme="light">

<header>
  <div class="brand">
    <img src="images/logo.png" alt="Logo SAGARA">
    <div>
      <h1>SIMPELKAS</h1>
      <p>Sistem Pelaporan KAS</p>
    </div>
  </div>
</header>

<div class="container">
  <section class="card">
    <h3><i class='bx bx-money'></i> Tambah Transaksi Kas</h3>

    <label>Nama</label>
    <input id="nama" type="text" placeholder="Contoh: Yanto">

    <label>Jenis Transaksi</label>
    <select id="jenis">
      <option value="pemasukan">Pemasukan</option>
      <option value="pengeluaran">Pengeluaran</option>
    </select>

    <label>Jumlah (Rp)</label>
    <input id="jumlah" type="number" placeholder="Contoh: 50000">

    <label>Tanggal</label>
    <input id="tanggal" type="date" value="">

    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="simpanTransaksi">Simpan Transaksi</button>
      <button id="scanQr" style="background:#0d9488">Scan QR</button>
      <button id="downloadPdf" style="background:#047857">Download PDF</button>
      <button id="exportJson" style="background:#0d6efd">Export JSON</button>
    </div>

    <div id="qr-reader" style="display:none;"></div>
  </section>

  <aside class="card">
    <h3><i class='bx bx-archive-in'></i> Riwayat Transaksi</h3>
    <label>Saldo Awal / Bulan Lalu (Rp)</label>
    <input id="saldoAwal" type="number" placeholder="Contoh: 100000" value="0">
    <button id="setSaldoAwal" style="margin-top:6px;background:#f59e0b;">Set Saldo Awal</button>

    <div id="history" style="max-height:400px; overflow:auto; margin-top:10px;"></div>
    <hr style="margin:14px 0">
    <div style="font-size:14px;">
      <p>Total Pemasukan: Rp <span id="totalPemasukan">0</span></p>
      <p>Total Pengeluaran: Rp <span id="totalPengeluaran">0</span></p>
      <p>Saldo Sekarang: Rp <span id="saldoSekarang">0</span></p>
    </div>
  </aside>
</div>

<footer>
© 2025 SAGARA — Sampang Generasi Remaja Aktif. All rights reserved.
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const KAS_KEY='sagara_kas_v1';
let kasList = JSON.parse(localStorage.getItem(KAS_KEY)||'[]');
let saldoAwal = 0;
let html5QrCode = null;

document.getElementById('tanggal').value = new Date().toISOString().slice(0,10);

function renderHistory(){
  const el = document.getElementById('history');
  if(kasList.length===0){ 
    el.innerHTML='<div class="list-empty">Belum ada transaksi</div>'; 
    document.getElementById('saldoSekarang').innerText = saldoAwal.toLocaleString();
    document.getElementById('totalPemasukan').innerText = '0';
    document.getElementById('totalPengeluaran').innerText = '0';
    return; 
  }

  let saldo = saldoAwal, totalPemasukan = 0, totalPengeluaran = 0;
  const rows = kasList.map((k, idx) => {
    if(k.jenis==='pemasukan'){ saldo+=k.jumlah; totalPemasukan+=k.jumlah; }
    else{ saldo-=k.jumlah; totalPengeluaran+=k.jumlah; }
    k.saldo = saldo;
    return `<tr>
      <td>${idx+1}</td>
      <td>${k.tanggal}</td>
      <td>${k.nama}</td>
      <td>${k.jenis}</td>
      <td>Rp ${k.jumlah.toLocaleString()}</td>
      <td>Rp ${k.saldo.toLocaleString()}</td>
      <td><button onclick="hapusTransaksi(${idx})" style="background:#dc2626;padding:4px 6px;border-radius:4px;font-size:12px;">Hapus</button></td>
    </tr>`;
  }).join('');

  el.innerHTML = `<table><thead><tr><th>No</th><th>Tanggal</th><th>Nama</th><th>Jenis</th><th>Jumlah</th><th>Saldo</th><th>Aksi</th></tr></thead><tbody>${rows}</tbody></table>`;
  document.getElementById('totalPemasukan').innerText = totalPemasukan.toLocaleString();
  document.getElementById('totalPengeluaran').innerText = totalPengeluaran.toLocaleString();
  document.getElementById('saldoSekarang').innerText = saldo.toLocaleString();
}

document.getElementById('simpanTransaksi').onclick = ()=>{
  const nama=document.getElementById('nama').value.trim();
  const jenis=document.getElementById('jenis').value;
  const jumlah=parseInt(document.getElementById('jumlah').value);
  const tanggal=document.getElementById('tanggal').value;
  if(!nama||!jumlah||!tanggal){ alert('Nama, jumlah, dan tanggal wajib diisi'); return; }

  kasList.push({id:'K'+Date.now(),nama,jenis,jumlah,tanggal});
  localStorage.setItem(KAS_KEY,JSON.stringify(kasList));
  renderHistory();

  document.getElementById('nama').value='';
  document.getElementById('jumlah').value='';
  document.getElementById('tanggal').value=new Date().toISOString().slice(0,10);
};

function hapusTransaksi(idx){
  if(confirm('Yakin ingin menghapus transaksi ini?')){
    kasList.splice(idx,1);
    localStorage.setItem(KAS_KEY,JSON.stringify(kasList));
    renderHistory();
  }
}

document.getElementById('setSaldoAwal').onclick = () => {
  const val = parseInt(document.getElementById('saldoAwal').value);
  if(isNaN(val)) { alert('Masukkan saldo awal yang valid'); return; }
  saldoAwal = val;
  renderHistory();
};

// === QR SCANNER FIX ===
html5QrCode.start(
  { facingMode: "environment" },
  qrConfig,
  qrCodeMessage => {
    let nama = qrCodeMessage;

    // Jika QR berformat JSON, ambil properti 'nama' saja
    try {
      const obj = JSON.parse(qrCodeMessage);
      if(obj.nama) nama = obj.nama.trim();
    } catch(e) {
      // QR bukan JSON, pakai langsung teks
      nama = qrCodeMessage.trim();
    }

    // Cegah duplikat scan cepat
    const lastTransaction = kasList[kasList.length - 1];
    if(lastTransaction && lastTransaction.nama === nama && lastTransaction.jumlah === 3000 && lastTransaction.tanggal === new Date().toISOString().slice(0,10)) {
      return;
    }

    // Tambah transaksi otomatis
    kasList.push({
      id: 'K' + Date.now(),
      nama: nama,
      jenis: 'pemasukan',
      jumlah: 3000,
      tanggal: new Date().toISOString().slice(0,10)
    });

    localStorage.setItem(KAS_KEY, JSON.stringify(kasList));
    renderHistory();
  },
  errorMessage => {
    // abaikan error kecil
  }
);

// Download PDF (versi rapi)
// === Download PDF (versi final tanpa kolom jabatan & tabel lebih rapat) ===
document.getElementById('downloadPdf').onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'landscape' }); // landscape biar tabel muat
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const marginX = 40, marginTop = 40, marginBottom = 60;
  const lineHeight = 14;
  let y = marginTop;

  const kopImg = new Image();
  kopImg.src = 'images/kop.png';
  kopImg.onload = function () {
    const ratio = kopImg.height / kopImg.width;
    const kopWidth = pageWidth - marginX * 2;
    const kopHeight = kopWidth * ratio;
    doc.addImage(kopImg, 'PNG', marginX, y, kopWidth, kopHeight);
    y += kopHeight + 10;

    // Judul
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('LAPORAN KAS SAGARA', pageWidth / 2, y, { align: 'center' });
    y += lineHeight * 2;

    let saldo = saldoAwal, totalPemasukan = 0, totalPengeluaran = 0;

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text(`Saldo Awal: Rp ${saldoAwal.toLocaleString()}`, marginX, y);
    y += lineHeight * 2;

    // Header tabel (tanpa jabatan)
    const headers = ['No', 'Tanggal', 'Nama', 'Jenis', 'Jumlah', 'Saldo'];
    // Lebar kolom disesuaikan supaya proporsional di landscape
    const colWidths = [30, 100, 160, 100, 130, 130];

    function drawHeader() {
      let x = marginX;
      const headerHeight = 20;
      doc.setFillColor(11, 35, 64); // biru tua seperti web
      doc.rect(marginX - 3, y - 12, pageWidth - marginX * 2 + 6, headerHeight, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      headers.forEach((h, i) => {
        const align = (i >= 4) ? 'right' : 'left';
        doc.text(h, align === 'right' ? x + colWidths[i] - 6 : x + 6, y + 3, { align });
        x += colWidths[i];
      });
      doc.setTextColor(0, 0, 0);
      y += lineHeight * 1.5; // jarak antar baris lebih rapat
    }

    drawHeader();

    // Baris data
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);

    kasList.forEach((k, idx) => {
      if (k.jenis === 'pemasukan') {
        saldo += k.jumlah;
        totalPemasukan += k.jumlah;
      } else {
        saldo -= k.jumlah;
        totalPengeluaran += k.jumlah;
      }

      if (y > pageHeight - marginBottom) {
        doc.addPage();
        y = marginTop;
        drawHeader();
      }

      const isEven = idx % 2 === 0;
      const rowHeight = 16;
      if (isEven) {
        doc.setFillColor(248, 250, 252);
        doc.rect(marginX - 3, y - 10, pageWidth - marginX * 2 + 6, rowHeight, 'F');
      }

      let x = marginX;
      const row = [
        (idx + 1).toString(),
        k.tanggal,
        k.nama,
        k.jenis,
        'Rp ' + k.jumlah.toLocaleString(),
        'Rp ' + saldo.toLocaleString()
      ];

      row.forEach((text, i) => {
        const align = (i >= 4) ? 'right' : 'left';
        doc.text(text, align === 'right' ? x + colWidths[i] - 6 : x + 6, y + 3, { align });
        x += colWidths[i];
      });

      y += lineHeight * 1.3; // jarak antar baris lebih rapat
    });

    // Total & Mengetahui
    y += lineHeight;
    if (y > pageHeight - marginBottom) {
      doc.addPage();
      y = marginTop;
    }

    doc.setFontSize(12);
    doc.text(`Total Pemasukan: Rp ${totalPemasukan.toLocaleString()}`, marginX, y); y += lineHeight * 1.3;
    doc.text(`Total Pengeluaran: Rp ${totalPengeluaran.toLocaleString()}`, marginX, y); y += lineHeight * 1.3;
    doc.text(`Saldo Sekarang: Rp ${saldo.toLocaleString()}`, marginX, y); y += lineHeight * 3;

    const namaKetua = 'ARYO YULIO PRASETYA';
    const namaBendahara = 'SARYO';
    const today = new Date();
    const options = { day: '2-digit', month: 'long', year: 'numeric' };
    const tanggalStr = today.toLocaleDateString('id-ID', options);

    y += lineHeight;
    doc.text(`Banjarnegara, ${tanggalStr}`, pageWidth - marginX, y, { align: 'right' });
    y += lineHeight * 2;
    doc.text('Mengetahui,', pageWidth / 2, y, { align: 'center' });
    y += lineHeight * 2;
    const leftX = pageWidth * 0.25, rightX = pageWidth * 0.75;
    doc.text('Ketua Organisasi', leftX, y, { align: 'center' });
    doc.text('Bendahara', rightX, y, { align: 'center' });
    y += lineHeight * 4;
    doc.setFont('helvetica', 'bold');
    doc.text(namaKetua, leftX, y, { align: 'center' });
    doc.text(namaBendahara, rightX, y, { align: 'center' });

    doc.save('laporan_kas_sagara.pdf');
  };

  kopImg.onerror = function () {
    alert('Gagal memuat kop surat. Pastikan file images/kop.png tersedia.');
  };
};
</script>

</body>
</html>
