<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Absensi SAGARA</title>
  <link rel="icon" href="images/logo.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <style>
    :root { --navy:#0b2340; --muted:#64748b; --bg:#f5f7fb; --card:#ffffff; }
    [data-theme="dark"]{ --navy:#f5f7fb; --muted:#94a3b8; --bg:#0b2340; --card:#1e293b; }
    * { box-sizing: border-box; font-family: 'Manrope', sans-serif; }
    body { margin:0; background:var(--bg); color:var(--navy); line-height:1.5; transition:0.3s; }
    header { display:flex; align-items:center; justify-content:space-between; padding:20px 24px; background:var(--card); box-shadow:0 4px 20px rgba(0,0,0,0.05); flex-wrap:wrap; gap:10px; }
    .brand { display:flex; align-items:center; gap:14px; flex-wrap:wrap; }
    .brand img { width:72px; height:72px; object-fit:contain; }
    .brand h1 { margin:0; font-size:22px; font-weight:700; }
    .brand p { margin:2px 0 0; color:var(--muted); font-size:14px; }
    .container { max-width:1200px; margin:30px auto; padding:0 20px; display:grid; grid-template-columns:2fr 1fr; gap:20px; }
    .card { background:var(--card); border-radius:14px; padding:22px; box-shadow:0 6px 24px rgba(11,35,64,0.06); transition:0.3s; }
    h3 { margin-top:0; font-size:18px; display:flex; align-items:center; gap:6px; }
    label { display:block; font-size:13px; color:var(--muted); margin-bottom:4px; margin-top:8px; }
    input[type=text], input[type=date], select { width:100%; padding:10px 12px; border:1px solid #e2e8f0; border-radius:8px; font-size:14px; }
    button { background:var(--navy); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; transition:all .2s ease; }
    button:hover { opacity:.9; }
    .small { padding:7px 10px; font-size:13px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; }
    th, td { border-bottom:1px solid #e2e8f0; padding:8px 6px; text-align:left; }
    th { color:var(--muted); font-weight:600; }
    footer { text-align:center; font-size:13px; color:var(--muted); margin:30px 0; padding:0 10px; }
    #reader { width:100%; max-height:250px; border-radius:8px; overflow:hidden; margin-bottom:0.3rem; }
    .theme-toggle { cursor:pointer; font-size:18px; }
    .whatsapp-float {
      position:fixed; bottom:20px; right:20px; background:#25d366; color:#fff;
      width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center;
      box-shadow:0 4px 12px rgba(0,0,0,0.3); z-index:999; text-decoration:none;
    }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast {
      background: var(--navy); color: #fff; padding: 10px 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      font-size: 14px; opacity: 0; transform: translateX(100%); transition: all 0.3s ease;
    }
    .toast.show { opacity: 1; transform: translateX(0); }
    .toast.success { background:#047857; }
    .toast.error { background:#ef4444; }
    .toast.info { background:#0d6efd; }

    @media(max-width:1024px){ .container { grid-template-columns:1fr; } }
    @media(max-width:600px){
      header { flex-direction:column; align-items:flex-start; justify-content:flex-start; text-align:left; }
      .brand img { width:60px; height:60px; }
      .card { padding:16px; }
      table { font-size:13px; }
      button, input { font-size:13px; }
      h3 { font-size:16px; }
    }
  </style>
</head>
<body data-theme="light">
  <header>
    <div class="brand">
      <img src="images/logo.png" alt="Logo SAGARA">
      <div>
        <h1>SISARA SAGARA</h1>
        <p>Sistem Absensi Rapat</p>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Bagian Kiri -->
    <section class="card">
      <h3><i class="bx bx-qr-scan"></i> Pemindaian QR Code</h3>
      <div class="input-group" style="margin-bottom:16px; display:flex; flex-wrap:wrap; gap:8px;">
        <select id="camera-select"></select>
        <button class="small" onclick="restartScanner()">Mulai / Ganti Kamera</button>
        <button class="small" style="background:#ef4444" onclick="stopScanner()">Matikan Kamera</button>
      </div>
      <div id="reader"></div>

      <h3 style="margin-top:20px;"><i class="bx bx-edit"></i> Absensi Manual</h3>
      <label>Nama</label>
      <input type="text" id="manualNama" placeholder="Masukkan nama...">
      <label>Jabatan</label>
      <select id="manualJabatan">
        <option value="">-- Pilih Jabatan --</option>
        <option>KETUA</option>
        <option>WAKIL KETUA</option>
        <option>SEKRETARIS</option>
        <option>BENDAHARA</option>
        <option>HUMAS</option>
        <option>SEKBID KEGIATAN</option>
        <option>SEKBID KEAMANAN</option>
        <option>SEKBID OLAHRAGA</option>
        <option>SEKBID KEAGAMAAN</option>
        <option>SEKBID SARPRAS</option>
        <option>ANGGOTA</option>
        <option value="lainnya">Lainnya</option>
      </select>
      <input type="text" id="manualJabatanLainnya" placeholder="Masukkan jabatan lainnya..." style="display:none;margin-top:6px;">
      <div style="margin-top:8px;">
        <button id="addManual">Tambahkan Manual</button>
      </div>

      <h3 style="margin-top:20px;"><i class="bx bx-list-check"></i> Daftar Absensi</h3>
      <table id="attendanceTable">
        <thead><tr><th>Nama</th><th>Jabatan</th><th>Waktu</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px;">
        <button id="clearLog" class="small" style="background:#6b7280">Bersihkan Daftar</button>
        <button id="exportCsv" class="small" style="background:#047857">Export CSV</button>
      </div>
    </section>

    <!-- Bagian Kanan -->
    <aside class="card">
      <h3><i class="bx bx-qr"></i> QR Generator</h3>
      <label>Nama</label>
      <input type="text" id="genNama" placeholder="Nama anggota...">
      <label>Jabatan</label>
      <select id="genJabatan">
        <option value="">-- Pilih Jabatan --</option>
        <option>KETUA</option>
        <option>WAKIL KETUA</option>
        <option>SEKRETARIS</option>
        <option>BENDAHARA</option>
        <option>HUMAS</option>
        <option>SEKBID KEGIATAN</option>
        <option>SEKBID KEAMANAN</option>
        <option>SEKBID OLAHRAGA</option>
        <option>SEKBID KEAGAMAAN</option>
        <option>SEKBID SARPRAS</option>
        <option>ANGGOTA</option>
        <option value="lainnya">Lainnya</option>
      </select>
      <input type="text" id="genJabatanLainnya" placeholder="Masukkan jabatan lainnya..." style="display:none;margin-top:6px;">
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <button id="generateQR">Buat QR</button>
        <button id="downloadQR" class="small">Download PNG</button>
      </div>
      <div id="qrCanvas" style="text-align:center;margin-top:14px;"></div>

      <hr style="margin:20px 0">
      <h3><i class="bx bx-file"></i> Dokumen Absensi</h3>
      <label>Keterangan Rapat</label>
      <input type="text" id="keterangan" placeholder="Contoh: Rapat Koordinasi Program Kerja">
      <label>Tanggal</label>
      <input type="date" id="tanggal">
      <div style="margin-top:10px;">
        <button id="downloadPdf">Download PDF Absensi</button>
      </div>
    </aside>
  </div>

  <footer>
    © 2025 SAGARA — Sampang Generasi Remaja Aktif. All rights reserved.
  </footer>

  <a href="https://wa.me/6281234567890" target="_blank" class="whatsapp-float" title="Hubungi Admin">
    <i class='bx bxl-whatsapp' style="font-size:24px;"></i>
  </a>

  <div class="theme-toggle" onclick="toggleTheme()" style="
    position:fixed; bottom:80px; right:20px;
    background:var(--navy); color:#fff; width:50px; height:50px; border-radius:50%;
    display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(0,0,0,0.3); z-index:1000; cursor:pointer;">
    <i class='bx bx-moon' style="font-size:24px"></i>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const manualJabatan = document.getElementById('manualJabatan');
    const manualJabatanLainnya = document.getElementById('manualJabatanLainnya');
    const genJabatan = document.getElementById('genJabatan');
    const genJabatanLainnya = document.getElementById('genJabatanLainnya');

    manualJabatan.addEventListener('change', () => {
      manualJabatanLainnya.style.display = manualJabatan.value === 'lainnya' ? 'block' : 'none';
    });
    genJabatan.addEventListener('change', () => {
      genJabatanLainnya.style.display = genJabatan.value === 'lainnya' ? 'block' : 'none';
    });

    let attendance = JSON.parse(localStorage.getItem('attendance')) || [];
    const tbody = document.querySelector('#attendanceTable tbody');
    const manualNama = document.getElementById('manualNama');
    const addManualBtn = document.getElementById('addManual');
    const genNama = document.getElementById('genNama');
    const qrCanvas = document.getElementById('qrCanvas');
    const generateQR = document.getElementById('generateQR');
    const downloadQR = document.getElementById('downloadQR');
    const downloadPdf = document.getElementById('downloadPdf');
    const clearLogBtn = document.getElementById('clearLog');
    const exportCsvBtn = document.getElementById('exportCsv');
    const keterangan = document.getElementById('keterangan');
    const tanggal = document.getElementById('tanggal');

    tanggal.value = new Date().toISOString().slice(0,10);

    // Toast function
    function showToast(message, type='info', duration=3000){
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerText = message;
      container.appendChild(toast);
      setTimeout(()=> toast.classList.add('show'), 50);
      setTimeout(()=>{
        toast.classList.remove('show');
        setTimeout(()=> container.removeChild(toast), 300);
      }, duration);
    }

    function saveData(){ localStorage.setItem('attendance', JSON.stringify(attendance)); }
    function renderTable(){
      if(attendance.length===0){
        tbody.innerHTML='<tr><td colspan="4" style="text-align:center;color:#94a3b8">Belum ada data absensi</td></tr>';
        return;
      }
      tbody.innerHTML = attendance.map((a,i)=>`<tr>
        <td>${a.nama}</td><td>${a.jabatan}</td><td>${a.waktu}</td>
        <td style="text-align:center;"><button class="small" style="background:#ef4444" onclick="deleteRow(${i})"><i class='bx bx-trash'></i></button></td>
      </tr>`).join('');
    }

    window.deleteRow=function(i){
      attendance.splice(i,1);
      saveData();
      renderTable();
      showToast('Data berhasil dihapus', 'success');
    }

    function addAttendance(n,j){
      attendance.push({nama:n,jabatan:j,waktu:new Date().toLocaleString('id-ID')});
      saveData();
      renderTable();
      showToast('Absensi berhasil ditambahkan', 'success');
    }

    // Tambah manual
addManualBtn.onclick = () => {
  const n = manualNama.value.trim();
  let j = manualJabatan.value.trim();

  // jika pilih "lainnya", ambil teks yang diketik
  if (j === 'lainnya') {
    j = manualJabatanLainnya.value.trim();
  }

  if (!n || !j) {
    showToast('Isi nama dan jabatan!', 'error');
    return;
  }

  if (!attendance.some(a => a.nama === n && a.jabatan === j)) {
    addAttendance(n, j);
  }

  manualNama.value = '';
  manualJabatan.value = '';
  manualJabatanLainnya.value = '';
  manualJabatanLainnya.style.display = 'none';
};

   // Generate QR
generateQR.onclick = () => {
  const n = genNama.value.trim();
  let j = genJabatan.value.trim();

  // jika pilih "lainnya", ambil teks dari input
  if (j === 'lainnya') {
    j = genJabatanLainnya.value.trim();
  }

  if (!n || !j) {
    showToast('Isi nama dan jabatan!', 'error');
    return;
  }

  qrCanvas.innerHTML = '';
  new QRCode(qrCanvas, { text: JSON.stringify({ nama: n, jabatan: j }), width: 200, height: 200 });
  showToast('QR berhasil dibuat', 'success');
};

    // Download QR
    downloadQR.onclick = ()=>{
      const img = qrCanvas.querySelector('img');
      if(!img) return showToast('Buat QR dulu!', 'error');
      const a = document.createElement('a');
      a.href = img.src;
      a.download = `qr-${genNama.value||'anggota'}.png`;
      a.click();
      showToast('QR berhasil diunduh!', 'success');
    };

    // Clear Log
    clearLogBtn.onclick = ()=>{
      if(attendance.length===0){ showToast('Belum ada data absensi!', 'info'); return; }
      attendance.length = 0;
      saveData();
      renderTable();
      showToast('Daftar absensi berhasil dibersihkan', 'success');
    };

    // Export CSV
    exportCsvBtn.onclick = ()=>{
      if(attendance.length===0){ showToast('Belum ada data absensi!', 'info'); return; }
      let csv='Nama,Jabatan,Waktu\n';
      attendance.forEach(a=>{ csv+=`${a.nama},${a.jabatan},${a.waktu}\n`; });
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Absensi_SAGARA_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('CSV berhasil diunduh!', 'success');
    };

    // Download PDF
    downloadPdf.onclick = ()=>{
      if(attendance.length===0){ showToast('Belum ada data absensi!', 'info'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt',format:'a4'});
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const marginX = 40, marginY = 40;
      const kopImg = new Image(); kopImg.src='images/kop.png';
      kopImg.onload = function(){
        const ratio = kopImg.height/kopImg.width;
        const kopWidth = pageWidth - marginX*2;
        const kopHeight = kopWidth*ratio;
        doc.addImage(kopImg,'PNG',marginX,marginY,kopWidth,kopHeight);
        const today=new Date();
        const formattedDate=today.toLocaleDateString('id-ID',{day:'2-digit',month:'long',year:'numeric'});
        doc.setFont('helvetica','normal'); doc.setFontSize(11);
        doc.text(`Banjarnegara, ${formattedDate}`,pageWidth-marginX,marginY+kopHeight+10,{align:'right'});
        doc.setFont('helvetica','bold'); doc.setFontSize(13.5); doc.text('DAFTAR HADIR KEGIATAN / RAPAT',pageWidth/2,marginY+kopHeight+42,{align:'center'});
        doc.setFontSize(12); doc.text('SAMPANG GENERASI REMAJA AKTIF (SAGARA)',pageWidth/2,marginY+kopHeight+60,{align:'center'});
        const ket=keterangan.value.trim()||'Rapat Koordinasi / Kegiatan Rutin';
        doc.setFont('helvetica','italic'); doc.setFontSize(11); doc.text(`“${ket}”`,pageWidth/2,marginY+kopHeight+78,{align:'center'});
        let y=marginY+kopHeight+105;
        doc.setFont('helvetica','bold'); doc.setFontSize(11);
        doc.text("No",marginX,y); doc.text("Nama",marginX+40,y); doc.text("Jabatan",marginX+240,y); doc.text("Waktu",marginX+400,y);
        doc.setFont('helvetica','normal'); doc.setFontSize(11);
        attendance.forEach((a,i)=>{
          y+=20;
          doc.text(`${i+1}`,marginX,y);
          doc.text(a.nama,marginX+40,y);
          doc.text(a.jabatan,marginX+240,y);
          doc.text(a.waktu,marginX+400,y);
        });
        const footerText = "Dokumen ini dicetak secara digital oleh Sistem Absensi SAGARA.";
doc.setFont('helvetica', 'italic');
doc.setFontSize(9);
doc.setTextColor(100,116,139); // abu-abu seperti var(--muted)
doc.text(footerText, pageWidth/2, pageHeight - 30, {align: 'center'});
        doc.save(`Absensi_SAGARA_${today.toISOString().slice(0,10)}.pdf`);
        showToast('PDF berhasil diunduh!', 'success');
      };
    };

    // Theme toggle
    function toggleTheme(){
      const t = document.body.getAttribute('data-theme');
      const next = t==='light'?'dark':'light';
      document.body.setAttribute('data-theme',next);
      showToast(`Mode ${next} diaktifkan`,'info');
    }

    renderTable();

    // Kamera QR
  let html5QrCode = null;
  const cameraSelect = document.getElementById('camera-select');

  // Ambil daftar kamera saat pertama kali
  async function initCameras() {
    try {
      const cameras = await Html5Qrcode.getCameras();
      if (cameras.length === 0) {
        showToast('Tidak ada kamera terdeteksi', 'error');
        return;
      }

      // isi dropdown kamera
      cameraSelect.innerHTML = '';
      cameras.forEach(c => {
        const opt = new Option(c.label || `Kamera ${cameraSelect.length + 1}`, c.id);
        cameraSelect.appendChild(opt);
      });

      // simpan kamera belakang jika ada
      const backCam = cameras.find(c => /back|rear|belakang/i.test(c.label));
      cameraSelect.value = backCam ? backCam.id : cameras[0].id;

      startScanner(cameraSelect.value);
    } catch (err) {
      showToast('Gagal mendapatkan daftar kamera', 'error');
      console.error(err);
    }
  }

  // Mulai scanner (versi fix: hanya 1 kali baca per QR)
async function startScanner(cameraId) {
  if (!cameraId) {
    showToast('Pilih kamera terlebih dahulu', 'info');
    return;
  }

  try {
    if (html5QrCode && html5QrCode._isScanning) {
      await html5QrCode.stop();
      html5QrCode.clear();
    }

    html5QrCode = new Html5Qrcode("reader");
    let lastScanned = "";        // menyimpan isi QR terakhir
    let lastScanTime = 0;        // waktu terakhir pemindaian

    await html5QrCode.start(
      { deviceId: { exact: cameraId } },
      { fps: 10, qrbox: 250 },
      qrCodeMessage => {
        const now = Date.now();

        // Cegah pembacaan berulang QR yang sama dalam 3 detik
        if (qrCodeMessage === lastScanned && now - lastScanTime < 3000) return;
        lastScanned = qrCodeMessage;
        lastScanTime = now;

        try {
          const obj = JSON.parse(qrCodeMessage);

          if (obj.nama && obj.jabatan) {
            // Cegah data duplikat di daftar absensi
            if (!attendance.some(a => a.nama === obj.nama && a.jabatan === obj.jabatan)) {
              addAttendance(obj.nama, obj.jabatan);
            } else {
              showToast(`Data ${obj.nama} sudah tercatat`, 'info');
            }
          } else {
            showToast('Format QR tidak lengkap', 'error');
          }
        } catch {
          showToast('QR tidak valid', 'error');
        }
      },
      errorMsg => { /* abaikan error dari kamera */ }
    );
  } catch (err) {
    console.error(err);
    showToast('Gagal memulai kamera', 'error');
  }
}

  // Tombol restart kamera
  async function restartScanner() {
    const selectedCamera = cameraSelect.value;
    startScanner(selectedCamera);
  }

  async function stopScanner() {
    if (html5QrCode && html5QrCode._isScanning) {
      await html5QrCode.stop();
      html5QrCode.clear();
      showToast('Kamera dimatikan', 'success');
    } else {
      showToast('Kamera belum aktif', 'info');
    }
  }

  // Jalankan awal
  initCameras();
  </script>
</body>
</html>
